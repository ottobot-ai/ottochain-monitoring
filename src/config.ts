/**
 * Watchdog configuration.
 *
 * All values can be overridden via environment variables.
 */

export interface NodeConfig {
  /** Human-friendly label */
  name: string;
  ip: string;
}

export interface HypergraphConfig {
  enabled: boolean;
  l0Urls: string[];
  l1Urls?: string[];
  metagraphId?: string;
  checkIntervalMultiplier: number;
}

export interface Config {
  /** Metagraph nodes (must match cluster size) */
  nodes: NodeConfig[];

  /** SSH key path for remote commands */
  sshKeyPath: string;
  sshUser: string;

  /** Layer ports (public API) */
  ports: {
    gl0: number;
    ml0: number;
    cl1: number;
    dl1: number;
  };

  /** CLI ports (internal, for join commands) */
  cliPorts: {
    gl0: number;
    ml0: number;
    cl1: number;
    dl1: number;
  };

  /** P2P ports */
  p2pPorts: {
    gl0: number;
    ml0: number;
    cl1: number;
    dl1: number;
  };

  /** Thresholds */
  snapshotStallMinutes: number;
  healthCheckIntervalSeconds: number;
  restartCooldownMinutes: number;
  maxRestartsPerHour: number;

  /** Redis URL for reading cached health data from services monitor */
  redisUrl: string;

  /** Postgres URL for reading events and writing restart events */
  postgresUrl: string;

  /** Seconds before health data is considered stale (triggers direct fallback) */
  healthDataStaleSeconds: number;

  /** Run mode */
  daemon: boolean;
  once: boolean;

  /** Optional hypergraph monitoring */
  hypergraph?: HypergraphConfig;
}

function buildHypergraphConfig(): HypergraphConfig | undefined {
  const enabled = process.env.HYPERGRAPH_ENABLED === 'true';
  if (!enabled) return undefined;

  const l0Urls = (process.env.HYPERGRAPH_L0_URLS ?? '').split(',').map(u => u.trim()).filter(Boolean);
  if (l0Urls.length === 0) return undefined;

  const l1Raw = process.env.HYPERGRAPH_L1_URLS;
  const l1Urls = l1Raw ? l1Raw.split(',').map(u => u.trim()).filter(Boolean) : undefined;

  return {
    enabled: true,
    l0Urls,
    l1Urls: l1Urls && l1Urls.length > 0 ? l1Urls : undefined,
    metagraphId: process.env.HYPERGRAPH_METAGRAPH_ID || undefined,
    checkIntervalMultiplier: int(process.env.HYPERGRAPH_CHECK_MULTIPLIER, 3),
  };
}

export function loadConfig(): Config {
  const nodeIps = (process.env.NODE_IPS ?? '10.0.0.1,10.0.0.2,10.0.0.3').split(',');
  const nodeNames = (process.env.NODE_NAMES ?? 'node1,node2,node3').split(',');

  return {
    nodes: nodeIps.map((ip, i) => ({
      name: nodeNames[i] ?? `node${i + 1}`,
      ip: ip.trim(),
    })),

    sshKeyPath: process.env.SSH_KEY_PATH ?? '/root/.ssh/hetzner_ottobot',
    sshUser: process.env.SSH_USER ?? 'root',

    ports: {
      gl0: int(process.env.GL0_PORT, 9000),
      ml0: int(process.env.ML0_PORT, 9200),
      cl1: int(process.env.CL1_PORT, 9300),
      dl1: int(process.env.DL1_PORT, 9400),
    },

    cliPorts: {
      gl0: int(process.env.GL0_CLI_PORT, 9002),
      ml0: int(process.env.ML0_CLI_PORT, 9202),
      cl1: int(process.env.CL1_CLI_PORT, 9302),
      dl1: int(process.env.DL1_CLI_PORT, 9402),
    },

    p2pPorts: {
      gl0: int(process.env.GL0_P2P_PORT, 9001),
      ml0: int(process.env.ML0_P2P_PORT, 9201),
      cl1: int(process.env.CL1_P2P_PORT, 9301),
      dl1: int(process.env.DL1_P2P_PORT, 9401),
    },

    snapshotStallMinutes: int(process.env.SNAPSHOT_STALL_MINUTES, 4),
    healthCheckIntervalSeconds: int(process.env.HEALTH_CHECK_INTERVAL, 60),
    restartCooldownMinutes: int(process.env.RESTART_COOLDOWN_MINUTES, 10),
    maxRestartsPerHour: int(process.env.MAX_RESTARTS_PER_HOUR, 6),

    redisUrl: process.env.REDIS_URL ?? 'redis://localhost:6379',
    postgresUrl: process.env.DATABASE_URL ?? 'postgresql://ottochain:ottochain-local-dev@localhost:5432/ottochain',
    healthDataStaleSeconds: int(process.env.HEALTH_DATA_STALE_SECONDS, 60),

    daemon: process.argv.includes('--daemon'),
    once: process.argv.includes('--once'),

    hypergraph: buildHypergraphConfig(),
  };
}

function int(val: string | undefined, fallback: number): number {
  return val ? parseInt(val, 10) : fallback;
}
