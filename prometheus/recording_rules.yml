# Recording rules for pre-computed metrics
# These run at evaluation_interval and store results for faster queries

groups:
  - name: ottochain_recording
    rules:
      # Memory usage percentage per node
      - record: ottochain:node_memory_usage_percent
        expr: |
          100 * (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes))

      # CPU usage percentage per node (1 minute average)
      - record: ottochain:node_cpu_usage_percent
        expr: |
          100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[1m])) * 100)

      # Disk usage percentage per node
      - record: ottochain:node_disk_usage_percent
        expr: |
          100 * (1 - (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}))

      # JVM heap usage percentage per tessellation node
      - record: ottochain:jvm_heap_usage_percent
        expr: |
          100 * (jvm_memory_bytes_used{area="heap"} / jvm_memory_bytes_max{area="heap"})

      # All nodes up status (1 = all up, 0 = at least one down)
      - record: ottochain:all_nodes_up
        expr: |
          min(up{job=~"gl0|ml0|cl1|dl1"})

  - name: consensus_recording
    rules:
      # Expected number of facilitators in the cluster
      # Update this value based on your cluster configuration
      - record: ottochain:cluster_expected_facilitators
        expr: |
          3

      # Average consensus duration (5 minute window)
      - record: ottochain:consensus_duration_avg_5m
        expr: |
          rate(dag_consensus_duration_sum{job=~"ml0|gl0"}[5m]) 
          / rate(dag_consensus_duration_count{job=~"ml0|gl0"}[5m])

      # Facilitator participation rate (%)
      - record: ottochain:facilitator_participation_percent
        expr: |
          (dag_global_snapshot_signature_count / on() group_left() ottochain:cluster_expected_facilitators) * 100

      # Snapshot lag vs wall clock (seconds)
      # Requires dag_global_snapshot_timestamp metric (milliseconds since epoch)
      - record: ottochain:snapshot_lag_seconds
        expr: |
          time() - (dag_global_snapshot_timestamp / 1000)

      # Consensus rounds per minute
      - record: ottochain:consensus_rounds_per_minute
        expr: |
          rate(dag_consensus_duration_count{job=~"ml0|gl0"}[1m]) * 60

      # Rejection rate (per minute)
      - record: ottochain:validation_rejection_rate_1m
        expr: |
          rate(dag_validation_rejections_total[1m]) * 60

      # Transaction throughput (per minute)
      - record: ottochain:transaction_throughput_1m
        expr: |
          rate(dag_global_snapshot_transactions_total[1m]) * 60
